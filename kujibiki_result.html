<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>くじ引き</title>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet" />
    <link rel="stylesheet" href="./css/kujibiki.css">
</head>
<body>
    <main class="transparent-bg">        
        <div class="kujibiki">
            <h2>くじ引き会場</h2>

            <section>
                <div class="entername">
                </div>
            </section>

            <section>
                <button id="run">抽選する</button>
            </section>

            <section>
                <p id="result"></p>
            </section>

            <section>
                <button id="reset">TOPに戻る</button>
            </section>

            <img src ="../images/next_target.png" alt="PR" class=pr>

        </div>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>

        const urlParams = new URLSearchParams(window.location.search);

        // 各パラメータ値を取得
        const theme = urlParams.get('theme');
        const participants = urlParams.get('participants');
        const winners = urlParams.get('winners');

        // 定義
        const name_ary=[];  //配列を定義
        
        // ページが開いたら発動
        $(document).ready(function() {
            
            // 選ぶ枠をリセット
            $(".entername").empty();

            // 当たる人数分の選ぶ枠をhtml内に設定、画像をランダムに表示
            for(let i=1; i<=participants; i++){
                const random_img = Math.floor(Math.random()*5) + 1;
                $(".entername").append('<div class="row_choices"> <img src="./images/kuji'+random_img+'.png" id="kuji" class="kuji'+i+'" alt="くじ"> <input type="text" class="name_ary" placeholder="名前を入力してください" name="name" value=""> </div>');
            }
        });

        // 複数人の当選者を決めるランダム関数の定義
        function random(array, num) {
            var a = array;
            var t = [];
            var r = [];
            var l = a.length;
            var n = num < l ? num : l;
            while (n-- > 0) {
                var i = (Math.random() * l) | 0;
                r[n] = t[i] || a[i];
                --l;
                t[i] = t[l] || a[l];
            }
            return r;
        }    
        
        // 「抽選する」ボタンが押されたら発動
        $("#run").on("click",function(){

            // 配列に入力された値を入れる
            let name_ary = $(".name_ary").serializeArray();
            
            // 事前に定義したrandom関数で当たり配列を作る
            let winner_list = random(name_ary, winners);
 
            // 当選者の名前を抽出して、整形された文字列を作成する
            let winner_names = winner_list.map(function(item) {
                return item.value;
            });

            // 結果を表示
            $("#result").text(winner_names.join("、") + "さん" + theme + "よろしくお願いします！");
                
            // あたりハズレに応じて画像を変換表示
            for(let i=0; i<name_ary.length; i++){
                const participant_name = name_ary[i].value;
                const Atari_num = i+1;
                const kuji_class = ".kuji"+ Atari_num;

                if(winner_names.includes(participant_name)){                    
                    $(kuji_class).attr('src','./images/kuji_atari.png');
                }else{
                    $(kuji_class).attr('src','./images/kuji_hazure.png');
                }
            }
        });
        
        $("#reset").on("click",function(){
            location.href = "index.html";
        });
    </script>
</body>
</html>